<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comparação de Listas - Upload</title>
  
  <!-- Bootstrap 5 (CSS) -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />
  
  <!-- SweetAlert2 para alertas bonitos -->
  <script 
    src="https://cdn.jsdelivr.net/npm/sweetalert2@11"
  ></script>

  <!-- SheetJS (XLSX) para ler Excel -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
  ></script>

  <!-- PDF.js: Ajuste a versão conforme desejar -->
  <script 
    src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js">
  </script>
  <script 
    src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js">
  </script>

  <style>
    body {
      background-color: #fff;      /* Fundo branco */
      color: #000;                 /* Texto preto */
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .highlight-color {
      color: #fec708;
    }
    .bg-highlight {
      background-color: #fec708 !important;
      color: #000 !important;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .card-header {
      background-color: #000;
      color: #fec708;
      font-weight: bold;
      text-align: center;
    }
    .form-label {
      font-weight: bold;
    }
    .btn-custom {
      background-color: #000;
      color: #fec708;
      border: 2px solid #fec708;
      transition: background-color 0.2s, color 0.2s;
    }
    .btn-custom:hover {
      background-color: #fec708;
      color: #000;
    }
    .btn-custom:focus {
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        
        <!-- Card de Upload -->
        <div class="card">
          <div class="card-header p-3">
            <h2 class="mb-0">Comparar Listas</h2>
          </div>
          <div class="card-body p-4">
            
            <!-- Input de arquivo: Lista de Alunos -->
            <div class="mb-4">
              <label for="fileAlunos" class="form-label">Lista de Alunos <span class="highlight-color">(Excel ou PDF)</span>:</label>
              <input 
                type="file" 
                class="form-control" 
                id="fileAlunos" 
                accept=".xlsx, .xls, .pdf"
              />
            </div>

            <!-- Input de arquivo: Lista de Aprovados -->
            <div class="mb-4">
              <label for="fileAprovados" class="form-label">Lista de Aprovados <span class="highlight-color">(Excel ou PDF)</span>:</label>
              <input 
                type="file" 
                class="form-control" 
                id="fileAprovados" 
                accept=".xlsx, .xls, .pdf"
              />
            </div>

            <!-- Botão de Comparar -->
            <div class="d-grid gap-2">
              <button 
                class="btn btn-custom btn-lg" 
                onclick="comparar()"
              >
                Comparar e Ver Resultado
              </button>
            </div>

          </div>
        </div>
        <!-- Fim Card -->

      </div>
    </div>
  </div>

  <script>
    //------------------------------------------------------------------
    // 1) FUNÇÃO PARA REMOVER ACENTOS E COLOCAR EM MAIÚSCULO
    //------------------------------------------------------------------
    function normalizeName(nome) {
      if (!nome) return "";
      // Remove acentos e transforma em maiúsculo
      return nome
        .normalize("NFD")             // Decompõe em caracteres + acentos
        .replace(/[\u0300-\u036f]/g,"") // Remove acentos
        .toUpperCase()
        .trim();
    }

    //------------------------------------------------------------------
    // 2) FUNÇÕES PARA LER ARQUIVOS (Excel ou PDF)
    //------------------------------------------------------------------
    async function lerArquivo(arquivo) {
      return new Promise((resolve, reject) => {
        if (!arquivo) {
          reject("Nenhum arquivo selecionado.");
          return;
        }
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        
        if (extensao === 'xlsx' || extensao === 'xls') {
          lerExcel(arquivo).then(resolve).catch(reject);
        } else if (extensao === 'pdf') {
          lerPDF(arquivo).then(resolve).catch(reject);
        } else {
          reject("Formato não suportado: " + extensao);
        }
      });
    }

    // Lê planilha Excel e extrai nomes da primeira coluna
    function lerExcel(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Vamos pegar apenas a primeira aba
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Ignorando a primeira linha (cabeçalho), assumindo que a coluna de nomes é a primeira (índice 0)
            const nomes = jsonData
              .slice(1)
              .map(row => (row[0] || "").toString().trim())
              .filter(Boolean);

            resolve(nomes);
          } catch (error) {
            reject("Erro ao ler Excel: " + error);
          }
        };
        reader.onerror = function(err) {
          reject("Erro ao carregar arquivo Excel: " + err);
        };
        reader.readAsArrayBuffer(arquivo);
      });
    }

    // Lê PDF usando pdf.js e extrai texto (simples)
    async function lerPDF(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            // Configura manualmente o worker (importante para evitar problemas de CORS)
            pdfjsLib.GlobalWorkerOptions.workerSrc =
              "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js";

            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
            let textoCompleto = "";

            for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
              const page = await pdf.getPage(pageNumber);
              const content = await page.getTextContent();
              const strings = content.items.map(item => item.str);
              textoCompleto += strings.join(" ") + "\n";
            }

            // Transformamos cada linha em um "possível nome"
            const linhas = textoCompleto
              .split(/\r?\n/)
              .map(l => l.trim())
              .filter(l => l.length > 0);

            resolve(linhas);
          } catch (error) {
            reject("Erro ao ler PDF: " + error);
          }
        };
        reader.onerror = function(err) {
          reject("Erro ao carregar arquivo PDF: " + err);
        };
        reader.readAsArrayBuffer(arquivo);
      });
    }

    //------------------------------------------------------------------
    // 3) FUNÇÃO PRINCIPAL: COMPARAR
    //------------------------------------------------------------------
    async function comparar() {
      const fileAlunos = document.getElementById('fileAlunos').files[0];
      const fileAprovados = document.getElementById('fileAprovados').files[0];

      if (!fileAlunos || !fileAprovados) {
        Swal.fire({
          icon: 'warning',
          title: 'Atenção',
          text: 'Por favor, selecione ambos os arquivos antes de prosseguir.'
        });
        return;
      }

      // Alerta de carregamento
      Swal.fire({
        title: 'Processando...',
        text: 'Lendo arquivos e comparando. Aguarde...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        // Leitura dos 2 arquivos em paralelo
        const [nomesAlunos, nomesAprovados] = await Promise.all([
          lerArquivo(fileAlunos),
          lerArquivo(fileAprovados)
        ]);

        // Normalizar nomes (tirar acentos, deixar maiúsculo)
        const alunosNormalizados = nomesAlunos.map(normalizeName);
        const aprovadosNormalizados = nomesAprovados.map(normalizeName);

        // Cria um Set para busca rápida
        const setAprovados = new Set(aprovadosNormalizados);

        // Monta array de { nomeOriginal, aprovado }
        const resultado = nomesAlunos.map((nomeOriginal, idx) => {
          const nomeNorm = alunosNormalizados[idx];
          const isAprovado = setAprovados.has(nomeNorm) ? "Sim" : "Não";
          return { nome: nomeOriginal, aprovado: isAprovado };
        });

        // Salva no localStorage
        localStorage.setItem("resultadoComparacao", JSON.stringify(resultado));

        // Fecha o alerta e redireciona
        Swal.close();
        window.location.href = "resultado.html";

      } catch (error) {
        console.error("Erro ao processar arquivos:", error);
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: error.toString()
        });
      }
    }
  </script>

  <!-- Bootstrap 5 (JS) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
  </script>
</body>
</html>
