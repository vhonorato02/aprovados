<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comparação de Listas - Upload</title>

  <!-- Bootstrap 5 (CSS) -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />

  <!-- Animate.css para animações -->
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"
  />

  <!-- SweetAlert2 para alertas bonitos -->
  <script 
    src="https://cdn.jsdelivr.net/npm/sweetalert2@11"
  ></script>

  <!-- Biblioteca XLSX (SheetJS) via CDN (para ler Excel) -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
  ></script>

  <!-- Biblioteca PDF.js (para ler PDF) - versão simplificada -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"
  ></script>
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js"
  ></script>

  <style>
    body {
      background: linear-gradient(to right, #00B4DB, #0083B0);
      min-height: 100vh;
      color: #fff;
    }
    .card {
      background-color: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 1rem;
      backdrop-filter: blur(10px);
    }
    .card-header {
      background-color: rgba(0, 0, 0, 0.2);
      border-bottom: none;
      text-align: center;
    }
    .card-body .form-label {
      font-weight: 600;
    }
    .btn-custom {
      background-color: #FF5722;
      color: #fff;
      border: none;
      transition: transform 0.2s;
    }
    .btn-custom:hover {
      transform: scale(1.05);
      background-color: #E64A19;
    }
    .title-shadow {
      text-shadow: 1px 1px 2px #000;
    }
  </style>
</head>
<body class="d-flex align-items-center justify-content-center">

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        
        <!-- Card de Upload -->
        <div class="card animate__animated animate__fadeInUp">
          <div class="card-header">
            <h3 class="mb-0 title-shadow">Comparação de Listas</h3>
          </div>
          <div class="card-body">
            
            <div class="mb-4">
              <label for="fileAlunos" class="form-label">
                <strong>Lista de Alunos do Colégio (Excel ou PDF):</strong>
              </label>
              <input 
                type="file" 
                class="form-control" 
                id="fileAlunos" 
                accept=".xlsx, .xls, .pdf"
              />
            </div>

            <div class="mb-4">
              <label for="fileAprovados" class="form-label">
                <strong>Lista de Aprovados (Excel ou PDF):</strong>
              </label>
              <input 
                type="file" 
                class="form-control" 
                id="fileAprovados" 
                accept=".xlsx, .xls, .pdf"
              />
            </div>

            <div class="d-grid gap-2">
              <button 
                class="btn btn-custom btn-lg animate__animated animate__pulse animate__infinite infinite" 
                onclick="comparar()"
              >
                Comparar e Ver Resultado
              </button>
            </div>

          </div>
        </div>
        <!-- Fim Card -->

      </div>
    </div>
  </div>

  <script>
    // ------------------------
    // LEITURA DE ARQUIVOS
    // ------------------------

    /**
     * Lê o arquivo e retorna uma Promise com um array de nomes extraído.
     * Verifica se é Excel (xls ou xlsx) ou PDF e chama a função correspondente.
     */
    function lerArquivo(arquivo) {
      return new Promise((resolve, reject) => {
        if (!arquivo) {
          return reject("Nenhum arquivo selecionado.");
        }
        
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        if (extensao === 'xlsx' || extensao === 'xls') {
          lerExcel(arquivo)
            .then(nomes => resolve(nomes))
            .catch(err => reject(err));
        } else if (extensao === 'pdf') {
          lerPDF(arquivo)
            .then(nomes => resolve(nomes))
            .catch(err => reject(err));
        } else {
          reject("Formato de arquivo não suportado: " + extensao);
        }
      });
    }

    /**
     * Lê um arquivo Excel e retorna um array de nomes (supondo que estejam na primeira coluna).
     */
    function lerExcel(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Ignora o cabeçalho e pega apenas a primeira coluna
            const nomes = jsonData.slice(1).map(linha => (linha[0] || "").toString().trim()).filter(Boolean);
            resolve(nomes);
          } catch (error) {
            reject("Erro ao ler planilha Excel: " + error);
          }
        };
        reader.onerror = function(error) {
          reject("Erro ao carregar arquivo Excel: " + error);
        };
        reader.readAsArrayBuffer(arquivo);
      });
    }

    /**
     * Lê um PDF usando PDF.js e retorna um array de nomes.
     * Neste exemplo, fazemos uma extração simples de texto.
     */
    function lerPDF(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const typedarray = new Uint8Array(e.target.result);
          try {
            const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
            let textoCompleto = "";

            for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
              const page = await pdf.getPage(pageNumber);
              const content = await page.getTextContent();
              const strings = content.items.map(item => item.str);
              textoCompleto += strings.join(" ") + "\n";
            }

            // Aqui fazemos um split simples por quebras de linha
            // e consideramos cada linha (ou pedaço de linha) como "um nome".
            // Você provavelmente precisará ajustar a lógica conforme o formato do seu PDF.
            let linhas = textoCompleto
              .split(/\r?\n/)
              .map(l => l.trim())
              .filter(l => l.length > 0);

            // Se você tiver um cabeçalho, ou informações adicionais, pode filtrar aqui.
            // Por exemplo, se quiser ignorar a primeira linha (cabeçalho):
            // linhas = linhas.slice(1);

            resolve(linhas);
          } catch (error) {
            reject("Erro ao ler PDF: " + error);
          }
        };
        reader.onerror = function(error) {
          reject("Erro ao carregar arquivo PDF: " + error);
        };
        reader.readAsArrayBuffer(arquivo);
      });
    }

    // ------------------------
    // COMPARAÇÃO DE LISTAS
    // ------------------------
    async function comparar() {
      const fileAlunos = document.getElementById('fileAlunos').files[0];
      const fileAprovados = document.getElementById('fileAprovados').files[0];

      if (!fileAlunos || !fileAprovados) {
        Swal.fire({
          icon: 'warning',
          title: 'Atenção',
          text: 'Por favor, selecione ambos os arquivos antes de prosseguir.'
        });
        return;
      }

      try {
        Swal.fire({
          title: 'Processando...',
          text: 'Por favor, aguarde enquanto processamos os arquivos.',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        const [nomesAlunos, nomesAprovados] = await Promise.all([
          lerArquivo(fileAlunos),
          lerArquivo(fileAprovados)
        ]);

        // Normaliza tudo em maiúsculo para comparar sem problemas de acentuação
        // (Claro que remover acentos seria ainda melhor, mas aqui faremos só upperCase).
        const setAprovados = new Set(nomesAprovados.map(n => n.toUpperCase()));

        // Construímos resultado
        const resultadoComparacao = nomesAlunos.map(nome => {
          return {
            nome,
            aprovado: setAprovados.has(nome.toUpperCase()) ? 'Sim' : 'Não'
          };
        });

        // Salva no localStorage
        localStorage.setItem("resultadoComparacao", JSON.stringify(resultadoComparacao));

        Swal.close(); // Fecha o loading

        // Redireciona
        window.location.href = "resultado.html";

      } catch (err) {
        console.error("Erro ao processar arquivos: ", err);
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Ocorreu um erro ao processar os arquivos: ' + err
        });
      }
    }
  </script>

  <!-- Bootstrap 5 (JS) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
  </script>
</body>
</html>
