<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comparação de Listas - Upload</title>
  
  <!-- Bootstrap 5 (CSS) -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />
  
  <!-- SweetAlert2 para alertas bonitos -->
  <script 
    src="https://cdn.jsdelivr.net/npm/sweetalert2@11"
  ></script>

  <!-- SheetJS (XLSX) para ler Excel -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
  ></script>

  <!-- PDF.js (versão 3.4.120) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js">
  </script>
  <script 
    src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js">
  </script>

  <style>
    /* ===== Estilos de Layout ===== */
    body {
      background-color: #fff; /* fundo branco */
      color: #000;            /* texto preto */
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .highlight-color {
      color: #fec708;
    }
    .card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .card-header {
      background-color: #000;
      color: #fec708;
      font-weight: bold;
      text-align: center;
    }
    .form-label {
      font-weight: bold;
    }
    .btn-custom {
      background-color: #000;
      color: #fec708;
      border: 2px solid #fec708;
      transition: background-color 0.2s, color 0.2s;
    }
    .btn-custom:hover {
      background-color: #fec708;
      color: #000;
    }
    .btn-custom:focus {
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        
        <!-- Card de Upload -->
        <div class="card">
          <div class="card-header p-3">
            <h2 class="mb-0">Comparar Listas</h2>
          </div>
          <div class="card-body p-4">
            
            <!-- Input de arquivo: Lista de Alunos -->
            <div class="mb-4">
              <label for="fileAlunos" class="form-label">
                Lista de Alunos 
                <span class="highlight-color">(Excel ou PDF)</span>:
              </label>
              <input 
                type="file" 
                class="form-control" 
                id="fileAlunos" 
                accept=".xlsx, .xls, .pdf"
              />
            </div>

            <!-- Input de arquivo: Lista de Aprovados -->
            <div class="mb-4">
              <label for="fileAprovados" class="form-label">
                Lista de Aprovados 
                <span class="highlight-color">(Excel ou PDF)</span>:
              </label>
              <input 
                type="file" 
                class="form-control" 
                id="fileAprovados" 
                accept=".xlsx, .xls, .pdf"
              />
            </div>

            <!-- Botão de Comparar -->
            <div class="d-grid gap-2">
              <button 
                class="btn btn-custom btn-lg" 
                onclick="comparar()"
              >
                Comparar e Ver Resultado
              </button>
            </div>

          </div>
        </div>
        <!-- Fim Card -->

      </div>
    </div>
  </div>

  <script>
    //----------------------------------------------------------------------
    // 1) Função para normalizar nomes (remover acentos, espaços extras, etc.)
    //----------------------------------------------------------------------
    function normalizeName(nome) {
      if (!nome) return "";
      // Substituir caracteres "non-breaking space" (\u00A0) por espaço normal
      let txt = nome.replace(/\u00A0/g, " ");
      // Substituir múltiplos espaços por apenas um
      txt = txt.replace(/\s+/g, " ");
      // Remover acentos
      txt = txt.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      // Converter para maiúsculo e trim
      return txt.toUpperCase().trim();
    }

    //----------------------------------------------------------------------
    // 2) Ler arquivo (Excel ou PDF) -> retorna array de strings
    //----------------------------------------------------------------------
    async function lerArquivo(arquivo) {
      return new Promise((resolve, reject) => {
        if (!arquivo) {
          reject("Nenhum arquivo selecionado.");
          return;
        }
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        
        if (extensao === 'xlsx' || extensao === 'xls') {
          lerExcel(arquivo).then(resolve).catch(reject);
        } else if (extensao === 'pdf') {
          lerPDF(arquivo).then(resolve).catch(reject);
        } else {
          reject("Formato não suportado: " + extensao);
        }
      });
    }

    //----------------------------------------------------------------------
    // 2a) Ler Excel (assumindo nomes na coluna 0, pulando cabeçalho)
    //----------------------------------------------------------------------
    function lerExcel(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            // Usa apenas a primeira aba
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            // Converte a planilha em array de arrays
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // Pula a primeira linha (cabeçalho). Ajuste se precisar pular mais
            const nomes = jsonData
              .slice(1)
              .map(row => (row[0] || "").toString().trim())
              .filter(Boolean);

            resolve(nomes);
          } catch (error) {
            reject("Erro ao ler Excel: " + error);
          }
        };
        reader.onerror = function(err) {
          reject("Erro ao carregar arquivo Excel: " + err);
        };
        reader.readAsArrayBuffer(arquivo);
      });
    }

    //----------------------------------------------------------------------
    // 2b) Ler PDF (extração simples do texto via pdf.js)
    //----------------------------------------------------------------------
    async function lerPDF(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            // Configura manualmente o worker do PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc =
              "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js";

            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;

            let textoCompleto = "";
            for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
              const page = await pdf.getPage(pageNumber);
              const content = await page.getTextContent();
              const strings = content.items.map(item => item.str);
              // Junta tudo em uma linha, separando com espaço
              textoCompleto += strings.join(" ") + "\n";
            }

            // Limpeza básica (remove non-breaking space e múltiplos espaços)
            let textoLimpo = textoCompleto
              .replace(/\u00A0/g, " ")
              .replace(/\s+/g, " ")
              .trim();

            // Separa por quebras de linha (rústico; ajuste conforme a formatação do PDF)
            const linhas = textoLimpo
              .split(/\r?\n/)
              .map(l => l.trim())
              .filter(l => l.length > 0);

            resolve(linhas);
          } catch (error) {
            reject("Erro ao ler PDF: " + error);
          }
        };
        reader.onerror = function(err) {
          reject("Erro ao carregar arquivo PDF: " + err);
        };
        reader.readAsArrayBuffer(arquivo);
      });
    }

    //----------------------------------------------------------------------
    // 3) Função principal: comparar os dois arquivos (alunos vs aprovados)
    //----------------------------------------------------------------------
    async function comparar() {
      const fileAlunos = document.getElementById('fileAlunos').files[0];
      const fileAprovados = document.getElementById('fileAprovados').files[0];

      if (!fileAlunos || !fileAprovados) {
        Swal.fire({
          icon: 'warning',
          title: 'Atenção',
          text: 'Por favor, selecione ambos os arquivos antes de prosseguir.'
        });
        return;
      }

      Swal.fire({
        title: 'Processando...',
        text: 'Lendo arquivos e comparando. Aguarde...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        // Ler ambos os arquivos simultaneamente
        const [listaAlunos, listaAprovados] = await Promise.all([
          lerArquivo(fileAlunos),
          lerArquivo(fileAprovados)
        ]);

        // Logs para debug
        console.log("DEBUG - Alunos (bruto):", listaAlunos);
        console.log("DEBUG - Aprovados (bruto):", listaAprovados);

        // Normaliza
        const alunosNormalizados = listaAlunos.map(normalizeName);
        const aprovadosNormalizados = listaAprovados.map(normalizeName);

        console.log("DEBUG - Alunos (normalizados):", alunosNormalizados);
        console.log("DEBUG - Aprovados (normalizados):", aprovadosNormalizados);

        // Cria um Set para busca rápida
        const setAprovados = new Set(aprovadosNormalizados);

        // Cria o array final com { nome, aprovado }
        const resultado = listaAlunos.map((nomeOriginal, idx) => {
          const nomeNorm = alunosNormalizados[idx];
          const estaAprovado = setAprovados.has(nomeNorm) ? "Sim" : "Não";
          return { nome: nomeOriginal, aprovado: estaAprovado };
        });

        // Armazena no localStorage
        localStorage.setItem("resultadoComparacao", JSON.stringify(resultado));

        // Fecha o alert e redireciona
        Swal.close();
        window.location.href = "resultado.html";

      } catch (error) {
        console.error("Erro ao processar arquivos:", error);
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: error.toString()
        });
      }
    }
  </script>

  <!-- Bootstrap 5 (JS) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
  </script>
</body>
</html>
